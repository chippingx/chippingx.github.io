<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>操作员 · 卸车任务</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .steps { display:flex; align-items:center; gap:8px; }
    .step { font-size:12px; background:#f3f4f6; color:#6b7280; padding:6px 10px; border-radius:9999px; }
    .step-active { background:#4f46e5; color:#fff; }
    .step-disabled { opacity:0.8; }
  </style>
</head>
<body>
  <script src="./simulator-layout.js"></script>
  <script src="./common.js"></script>
  <script>
    initSimulatorLayout({
      title: '卸车任务 · 操作员',
      titleIcon: 'fas fa-dolly',
      role: 'operator',
      activeNav: 'operate',
      content: `
        <div class="px-6 py-4 pb-28">
          <div class="steps mb-3">
            <div id="stepStart" class="step step-active">开始卸车</div>
            <div class="text-gray-400">→</div>
            <div id="stepRecord" class="step step-disabled">卸车中</div>
            <div class="text-gray-400">→</div>
            <div id="stepFinish" class="step step-disabled">完成卸车</div>
          </div>
          <div id="topProgress" class="flex items-center justify-between mb-3 text-xs text-gray-700 hidden">
            <div><span class="text-gray-500 mr-2">任务号</span><span id="topTaskId" class="font-semibold text-gray-800">--</span> · 进度：<span id="topProgText">托盘 0/0, 散货 0/0</span></div>
          </div>
          <div id="taskCard" class="card rounded-2xl p-4 mb-3"></div>
          <div id="opsCard" class="card rounded-2xl p-4 mb-3"></div>
          <div id="recordsCard" class="card rounded-2xl p-4 mb-3"></div>
          <div id="finishCard" class="card rounded-2xl p-4 mb-3 hidden"></div>
          <div id="actionCard" class="card rounded-2xl p-4"></div>
        </div>
      `
    });
  </script>

  <script>
    function qs(name){ const u=new URLSearchParams(window.location.search); return u.get(name); }
    const taskId = qs('task_id') || 'TN20240520001';
    const refresh = qs('refresh')==='true';
    let appData = null;

    function loadData(){ if(appData) return Promise.resolve(appData); const url = new URL('app-data.json', document.baseURI).href; if(location.protocol==='file:'){ appData = (window.APP_DATA_FALLBACK||{ operatorTasks: [] }); return Promise.resolve(appData); } return fetch(url).then(r=>{ if(!r.ok) throw new Error('fail'); return r.json(); }).then(d=>{ appData=d; return d; }).catch(()=>{ appData = (window.APP_DATA_FALLBACK||{ operatorTasks: [] }); return appData; }); }

    function addLooseRecord(){ window.location.href = 'operator-unloading-edit.html?task_id='+encodeURIComponent(taskId)+'&type=loose'; }
    function addTrayRecord(){ window.location.href = 'operator-unloading-edit.html?task_id='+encodeURIComponent(taskId)+'&type=tray'; }
    function backDetail(){ window.location.href = 'operator-task-detail.html?task_id='+encodeURIComponent(taskId); }

    function getState(){ try{ const s=localStorage.getItem('unloadState:'+taskId); return s||'waiting'; }catch(e){ return 'waiting'; } }
    function setState(s){ try{ localStorage.setItem('unloadState:'+taskId, s); }catch(e){} applyState(s); }
    function applyState(s){
      document.getElementById('stepStart').className = 'step '+(s==='waiting'?'step-active':'');
      document.getElementById('stepRecord').className = 'step '+(s==='unloading'?'step-active':'');
      document.getElementById('stepFinish').className = 'step '+(s==='finished'?'step-active':'');
      document.getElementById('topProgress').style.display = (s==='unloading' ? 'flex' : 'none');
      document.getElementById('taskCard').style.display = (s==='waiting' ? 'block' : 'none');
      document.getElementById('opsCard').style.display = (s==='unloading' ? 'block' : 'none');
      document.getElementById('recordsCard').style.display = (s==='unloading' ? 'block' : 'none');
      document.getElementById('finishCard').style.display = (s==='finished' ? 'block' : 'none');
    }
    function renderTask(){ const el=document.getElementById('taskCard'); el.innerHTML = `
      <div class='text-sm font-semibold text-gray-800'>任务号 ${taskId}</div>
      <div class='text-xs text-gray-500 mt-1'>开始前请确认任务状态为待卸货</div>
      <div class='mt-2'><button class='px-3 py-2 text-sm rounded bg-indigo-600 text-white' onclick='startUnload()'><i class='fas fa-play mr-1'></i>开始卸车</button></div>
    `; }
    function startUnload(){
      setState('unloading');
      renderOps(); renderRecords(); renderActions(); updateProgress();
    }
    function renderOps(){ const el=document.getElementById('opsCard'); el.innerHTML = `
      <div class='text-sm font-semibold text-gray-800 mb-2'>添加记录</div>
      <div class='flex items-center gap-2'>
        <button class='px-3 py-2 text-sm rounded bg-indigo-600 text-white' onclick='addTrayRecord()'><i class='fas fa-qrcode mr-1'></i>整托</button>
        <button class='px-3 py-2 text-sm rounded bg-green-600 text-white' onclick='addLooseRecord()'><i class='fas fa-plus mr-1'></i>散货</button>
      </div>
    `; }
    function renderRecords(){
      const el = document.getElementById('recordsCard');
      const raw = localStorage.getItem('unloadRecords:'+taskId);
      const arr = raw ? JSON.parse(raw) : [];
      if(arr.length===0){ el.innerHTML = `<div class='text-xs text-gray-600'>暂无卸车记录</div>`; return; }
      const list = document.createElement('div');
      list.className = 'space-y-2';
      arr.forEach(r=>{
        const row = document.createElement('div');
        row.className = 'bg-gray-50 rounded-xl p-3';
        const viewHref = 'operator-unloading-edit.html?task_id='+encodeURIComponent(taskId)+'&record_id='+(r.record_id||r.id)+'&readonly=true&from=task_detail';
        row.innerHTML = `
          <div class='flex items-center justify-between'>
            <div>
              <div class='text-sm font-semibold text-gray-800'>${r.record_type==='tray'?'整托':'散货'} · ${r.record_id||r.id}</div>
              <div class='text-xs text-gray-500 mt-0.5'>状态 ${r.status||'--'}</div>
            </div>
            <div class='flex items-center gap-2'>
              <a class='px-2 py-1 text-xs rounded bg-gray-100' href='${viewHref}'><i class='fas fa-eye'></i> 查看</a>
            </div>
          </div>
        `;
        list.appendChild(row);
      });
      el.innerHTML = '';
      el.appendChild(list);
    }
    function updateProgress(){ const raw = localStorage.getItem('unloadRecords:'+taskId); const arr = raw?JSON.parse(raw):[]; const trayTotal=arr.filter(r=>r.record_type==='tray').length; const trayDone=arr.filter(r=>r.record_type==='tray' && r.status==='done').length; const looseTotal=arr.filter(r=>r.record_type==='loose').length; const looseDone=arr.filter(r=>r.record_type==='loose' && r.status==='done').length; document.getElementById('topProgText').textContent = `托盘 ${trayDone}/${trayTotal}, 散货 ${looseDone}/${looseTotal}`; }
    function renderActions(){ const el=document.getElementById('actionCard'); el.innerHTML = `
      <div class='flex items-center gap-2'>
        <button class='px-3 py-2 text-sm rounded bg-gray-100' onclick='backDetail()'><i class='fas fa-arrow-left mr-1'></i>返回任务详情</button>
        <button class='px-3 py-2 text-sm rounded bg-indigo-600 text-white' onclick='gotoFinish()'><i class='fas fa-check mr-1'></i>进仓完成</button>
      </div>
    `; }
    function gotoFinish(){ setState('finished'); renderFinish(); }
    function renderFinish(){ const el=document.getElementById('finishCard'); el.innerHTML = `
      <div class='text-sm font-semibold text-gray-800 mb-2'>完成卸车</div>
      <div class='space-y-2 text-sm'>
        <label class='inline-flex items-center gap-2'><input id='chkTray' type='checkbox' /> <span>所有托盘已完成</span></label>
        <label class='inline-flex items-center gap-2'><input id='chkLoose' type='checkbox' /> <span>所有散货已完成</span></label>
        <label class='inline-flex items-center gap-2'><input id='chkGuard' type='checkbox' /> <span>所有大件已监护完成</span></label>
      </div>
      <div class='mt-3 grid grid-cols-2 gap-2'>
        <button id='btnFinishOk' class='px-3 py-2 text-sm rounded bg-indigo-600 text-white disabled:opacity-50' disabled><i class='fas fa-check mr-1'></i>完成卸车</button>
        <button class='px-3 py-2 text-sm rounded bg-gray-100' onclick='cancelFinish()'><i class='fas fa-undo mr-1'></i>取消完成卸车</button>
      </div>
    `; var updateEnable=function(){ var ok=document.getElementById('btnFinishOk'); var a=document.getElementById('chkTray').checked; var b=document.getElementById('chkLoose').checked; var c=document.getElementById('chkGuard').checked; ok.disabled = !(a&&b&&c); }; ['chkTray','chkLoose','chkGuard'].forEach(function(id){ var el=document.getElementById(id); if(el){ el.onchange=updateEnable; } }); var btn=document.getElementById('btnFinishOk'); if(btn){ btn.onclick=function(){ toastShow('已标记完成','ok'); backDetail(); }; }
    }
    function cancelFinish(){ setState('unloading'); renderOps(); renderRecords(); renderActions(); updateProgress(); }

    renderTask(); renderOps(); renderRecords(); renderActions();
    if(refresh){ updateProgress(); }
    applyState(getState());
  </script>
</body>
</html>
