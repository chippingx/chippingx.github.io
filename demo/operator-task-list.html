<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>操作员 · 任务清单</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <script src="./simulator-layout.js"></script>
  <script src="./common.js"></script>
  <script>
    initSimulatorLayout({
      title: '任务清单 · 操作员',
      titleIcon: 'fas fa-list',
      role: 'operator',
      activeNav: 'tasks',
      content: `
        <div class="px-6 py-4 pb-28">
          <div class="bg-white rounded-2xl p-4 mb-3 shadow-sm border border-gray-100">
            <div class="grid grid-cols-2 gap-2 mb-3">
              <input id="search" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all" placeholder="搜索任务号/车牌..." />
              <div id="sortTrigger" class="px-3 py-2 border border-gray-200 rounded-lg text-sm text-gray-700 flex items-center justify-between cursor-pointer active:bg-gray-50 transition-all bg-white">
                <span id="sortText">按时间顺序</span>
                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
              </div>
            </div>
            <div class="flex items-center gap-2 text-xs overflow-x-auto pb-1 scrollbar-hide">
              <button id="tabMe" class="flex-none px-4 py-1.5 rounded-full bg-gray-100 text-gray-600 font-medium transition-colors">等待我处理</button>
              <button id="tabOthers" class="flex-none px-4 py-1.5 rounded-full bg-gray-100 text-gray-600 font-medium transition-colors">等待他人处理</button>
              <button id="tabDone" class="flex-none px-4 py-1.5 rounded-full bg-gray-100 text-gray-600 font-medium transition-colors">已完成</button>
            </div>
          </div>

          <div id="list" class="space-y-3"></div>
        </div>
      `
    });
  </script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const initialFilter = urlParams.get('filter') || 'waiting_me';
    let appData = null;
    function loadData(){ if(appData) return Promise.resolve(appData); const url = new URL('app-data.json', document.baseURI).href; if(location.protocol==='file:'){ appData = (window.APP_DATA_FALLBACK||{ operatorTasks: [] }); return Promise.resolve(appData); } return fetch(url).then(r=>{ if(!r.ok) throw new Error('fail'); return r.json(); }).then(d=>{ appData=d; return d; }).catch(()=>{ appData = (window.APP_DATA_FALLBACK||{ operatorTasks: [] }); return appData; }); }

    let currentSort = 'time';
    const sortOptions = [
        { value: 'time', label: '按时间顺序' },
        { value: 'category', label: '任务类别' }
    ];
    const sortPanel = window.createSelectionPanel({
        id: 'sortPanel',
        title: '排序方式',
        confirmText: '确认',
        onConfirm: function(val){
            if(!val) return;
            currentSort = val;
            const label = sortOptions.find(o=>o.value===val)?.label || val;
            document.getElementById('sortText').textContent = label;
            sortPanel.close();
            render();
        }
    });
    document.getElementById('sortTrigger').onclick = function(){
        sortPanel.open(sortOptions, currentSort);
    };

    function render(){
      loadData().then(()=>{
        const tasks = (appData.operatorTasks||[]).slice();
        const search = document.getElementById('search').value.trim().toLowerCase();
        const sort = currentSort;
        let filtered = tasks.filter(t=> (currentFilter==='waiting_me' ? t.waiting_me===true && t.stage!=='completed' : (currentFilter==='waiting_others' ? t.waiting_me!==true && t.stage!=='completed' : t.stage==='completed')));
        if(search){ filtered = filtered.filter(t=> (t.id||'').toLowerCase().includes(search) || (t.plate||'').toLowerCase().includes(search)); }
        if(sort==='time'){
          filtered.sort((a,b)=> new Date(b.state_time||b.created_at||0) - new Date(a.state_time||a.created_at||0));
        } else if(sort==='category'){
          const stageOrder = { waiting_inbound_accept:1, waiting_door_assign:2, waiting_call:3, waiting_unload:4, unloading:5, supervision:6, completed:7 };
          filtered.sort((a,b)=>{
            const catCmp = (a.category||'').localeCompare(b.category||'');
            if(catCmp!==0) return catCmp;
            const sa = stageOrder[a.stage]||99; const sb = stageOrder[b.stage]||99;
            if(sa!==sb) return sa-sb;
            return new Date(b.state_time||b.created_at||0) - new Date(a.state_time||a.created_at||0);
          });
        }
        const list = document.getElementById('list');
        list.innerHTML = '';
        if(filtered.length===0){ list.innerHTML = `<div class='bg-white rounded-2xl p-8 text-center text-sm text-gray-500 flex flex-col items-center shadow-sm border border-gray-100'><i class="fas fa-clipboard-list text-4xl text-gray-300 mb-3"></i>暂无任务</div>`; return; }
        
        filtered.forEach(t=>{
          const item = document.createElement('div');
          item.className = 'bg-white rounded-2xl p-4 shadow-sm border border-gray-100 active:scale-[0.99] transition-transform cursor-pointer';
          
          let badgeClass = '';
          if(t.stage==='completed') badgeClass = 'bg-green-50 text-green-700 border border-green-100';
          else if(t.waiting_me===true) badgeClass = 'bg-yellow-50 text-yellow-700 border border-yellow-100';
          else badgeClass = 'bg-gray-50 text-gray-600 border border-gray-200';

          const actionBtn = (t.waiting_me===true && t.stage!=='completed') ? 
            `<button class='px-3 py-1.5 text-xs font-medium rounded-lg bg-indigo-600 text-white shadow-sm shadow-indigo-200 active:bg-indigo-700' onclick=\"event.stopPropagation(); goProcess('${t.id}','${t.stage}')\"><i class='fas fa-arrow-right mr-1'></i>处理</button>` : '';

          // Meta info
          const parts = [];
          if(t.door) parts.push(`<i class="fas fa-door-open text-gray-400 mr-1"></i>${t.door}`);
          if(t.plate) parts.push(`<i class="fas fa-truck text-gray-400 mr-1"></i>${t.plate}`);
          
          const waitTime = Math.floor(Math.random() * 60) + ' min'; // Mock wait time

          item.innerHTML = `
            <div class='flex items-start justify-between mb-2'>
              <div>
                <div class='flex items-center'>
                  <span class='text-base font-bold text-gray-800'>${t.id}</span>
                  <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 border border-gray-200 ml-2">${t.category||'普通'}</span>
                </div>
                <div class="text-xs text-gray-500 mt-0.5">${labelOfStage(t.stage)}</div>
              </div>
              <span class='px-2 py-1 rounded-lg text-xs font-medium ${badgeClass}'>${t.waiting_me?'待我处理':(t.stage==='completed'?'已完成':'待他人')}</span>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-2 mb-3 text-xs">
               <div class="flex items-center gap-2 text-gray-700 flex-1 min-w-0">
                 <span class="flex items-center truncate"><i class="fas fa-truck text-gray-400 mr-1 flex-none"></i>${t.plate||'--'}</span>
                 ${t.door ? `<span class="text-gray-300">|</span><span class="flex items-center truncate"><i class="fas fa-door-open text-gray-400 mr-1 flex-none"></i>${t.door}</span>` : ''}
               </div>
            </div>

            <div class='flex items-center justify-between gap-2'>
               <div class="flex items-center text-xs text-gray-400">
                 <i class="fas fa-clock w-4 text-center mr-1"></i><span>等待: ${waitTime}</span>
               </div>
               ${actionBtn}
            </div>
        `;
          item.onclick = ()=>{ goDetail(t.id); };
          list.appendChild(item);
        });
      });
    }

    function labelOfStage(stage){
      if(stage==='waiting_unload') return '等待卸车';
      if(stage==='waiting_inbound_accept') return '等待进仓受理';
      if(stage==='waiting_door_assign') return '等待库门分配';
      if(stage==='waiting_call') return '等待叫车';
      if(stage==='unloading') return '卸车中';
      if(stage==='supervision' || stage==='waiting_supervision') return '监管介入';
      if(stage==='completed') return '已完成';
      return '待处理';
    }
    function goDetail(id){ window.location.href = 'operator-task-detail.html?task_id=' + encodeURIComponent(id); }
    function goProcess(id, stage){ if(stage==='waiting_inbound_accept'){ window.location.href = 'operator-inbound-accept.html?task_id=' + encodeURIComponent(id); } else { window.location.href = 'operator-unloading-task.html?task_id=' + encodeURIComponent(id); } }
    function setActiveTabs(){
      document.getElementById('tabMe').className = 'flex-none px-4 py-1.5 rounded-full font-medium transition-colors ' + (currentFilter==='waiting_me' ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200');
      document.getElementById('tabOthers').className = 'flex-none px-4 py-1.5 rounded-full font-medium transition-colors ' + (currentFilter==='waiting_others' ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200');
      document.getElementById('tabDone').className = 'flex-none px-4 py-1.5 rounded-full font-medium transition-colors ' + (currentFilter==='completed' ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200');
    }

    let currentFilter = initialFilter;
    document.getElementById('tabMe').onclick = ()=>{ currentFilter='waiting_me'; setActiveTabs(); render(); };
    document.getElementById('tabOthers').onclick = ()=>{ currentFilter='waiting_others'; setActiveTabs(); render(); };
    document.getElementById('tabDone').onclick = ()=>{ currentFilter='completed'; setActiveTabs(); render(); };
    document.getElementById('search').oninput = render;
    // document.getElementById('sort').onchange = render;

    setActiveTabs();
    render();
  </script>
</body>
</html>
