<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>调度员 · 库门列表</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <script src="./simulator-layout.js"></script>
  <script src="./common.js"></script>
  <script>
    initSimulatorLayout({
      title: '库门列表 · 调度员',
      titleIcon: 'fas fa-door-open',
      role: 'dispatcher',
      activeNav: 'resources',
      content: `
        <div class="px-6 py-4 pb-28">
          <div class="card rounded-2xl p-2 mb-4 bg-white shadow-sm border border-gray-100">
            <div class="flex items-center gap-2 text-xs overflow-x-auto p-1 scrollbar-hide">
              <button id="tabAll" class="flex-1 px-4 py-2 rounded-xl font-medium transition-colors">全部</button>
              <button id="tabPaused" class="flex-1 px-4 py-2 rounded-xl font-medium transition-colors">暂停</button>
              <button id="tabLimited" class="flex-1 px-4 py-2 rounded-xl font-medium transition-colors">限制</button>
            </div>
          </div>

          <div id="list" class="space-y-3"></div>
        </div>
      `
    });
  </script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const initialFilter = urlParams.get('filter') || 'all';
    
    let appData = null;
    function loadData(){
        const url = new URL('app-data.json', document.baseURI).href;
        if(location.protocol === 'file:'){
            appData = (window.APP_DATA_FALLBACK || {}); 
            return Promise.resolve(appData);
        }
        return fetch(url).then(r => r.json()).then(d => { appData = d; return d; }).catch(e=>{ console.error(e); return {}; });
    }

    let doors = [];
    let currentFilter = initialFilter;

    function getDuration(timestamp){
      if(!timestamp) return '';
      // Mock current time for prototype consistency
      const nowTime = new Date('2025-12-02T09:30:00').getTime(); 
      const startTime = new Date(timestamp).getTime();
      const diff = Math.max(0, nowTime - startTime);
      
      const minutes = Math.floor(diff / 60000);
      if(minutes < 60) return `${minutes}分钟`;
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours}小时${mins}分钟`;
    }

    function render(){
      if(!appData) return;
      doors = appData.doors || [];

      // Mapping filter
      let filtered = doors;
      if(currentFilter === 'paused') filtered = doors.filter(d => d.status === 'paused');
      else if(currentFilter === 'limited') filtered = doors.filter(d => d.status === 'limited');
      
      // Sort: Paused/Limited first, then by ID
      filtered.sort((a,b) => {
          const score = s => (s==='paused'?3 : s==='limited'?2 : s==='working'?1 : 0);
          return (score(b.status) - score(a.status)) || a.id.localeCompare(b.id);
      });

      const list = document.getElementById('list');
      list.innerHTML = '';
      
      if(filtered.length===0){ 
          list.innerHTML = `<div class='py-12 text-center text-sm text-gray-500 flex flex-col items-center'><i class="fas fa-door-closed text-4xl text-gray-200 mb-3"></i>暂无相关库门</div>`; 
          return; 
      }
      
      filtered.forEach(d=>{
        const item = document.createElement('div');
        item.className = 'bg-white rounded-2xl p-4 shadow-sm border border-gray-100 active:scale-[0.99] transition-transform';
        
        let statusBadge = '';
        let statusText = '';
        if(d.status==='working'){ statusBadge='bg-green-50 text-green-700 border-green-100'; statusText='启用中'; }
        else if(d.status==='paused'){ statusBadge='bg-orange-50 text-orange-700 border-orange-100'; statusText='暂停'; }
        else if(d.status==='limited'){ statusBadge='bg-red-50 text-red-700 border-red-100'; statusText='限制'; }
        else { statusBadge='bg-gray-50 text-gray-600 border-gray-100'; statusText='已关闭'; }

        const oversizeTag = d.supportsOversize ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-indigo-50 text-indigo-600 border border-indigo-100 ml-2">支持大件</span>' : '';
        
        let durationHtml = '';
        if((d.status === 'paused' || d.status === 'limited') && d.statusTimestamp){
           const duration = getDuration(d.statusTimestamp);
           durationHtml = `<div class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-50 flex items-center"><i class="far fa-clock mr-1.5"></i>已${statusText}${duration}</div>`;
        }

        item.innerHTML = `
          <div class='flex items-center justify-between mb-3'>
            <div class='flex items-center'>
              <span class='text-lg font-bold text-gray-800'>${d.id}</span>
              ${oversizeTag}
            </div>
            <span class='px-2.5 py-1 rounded-lg text-xs font-bold border ${statusBadge}'>${statusText}</span>
          </div>
          
          <div class="grid grid-cols-2 gap-3 text-sm">
             <div class="bg-gray-50 rounded-xl p-2 flex items-center justify-between">
                <span class="text-gray-500 text-xs">当前排队</span>
                <span class="font-bold text-gray-800">${d.queue}</span>
             </div>
             <div class="bg-gray-50 rounded-xl p-2 flex items-center justify-between">
                <span class="text-gray-500 text-xs">作业任务</span>
                <span class="font-bold text-gray-800 truncate max-w-[80px] text-right">${d.currentTask || '--'}</span>
             </div>
          </div>
          ${durationHtml}
        `;
        item.onclick = ()=>{ window.location.href = `dispatcher-door-detail.html?door=${d.id}`; };
        list.appendChild(item);
      });
    }

    function setActiveTabs(){
      const base = 'flex-1 px-4 py-2 rounded-xl font-medium transition-colors border ';
      const active = 'bg-indigo-600 text-white border-indigo-600 shadow-md shadow-indigo-200';
      const inactive = 'bg-white text-gray-500 border-transparent hover:bg-gray-50';

      document.getElementById('tabAll').className = base + (currentFilter==='all' ? active : inactive);
      document.getElementById('tabPaused').className = base + (currentFilter==='paused' ? active : inactive);
      document.getElementById('tabLimited').className = base + (currentFilter==='limited' ? active : inactive);
    }

    document.getElementById('tabAll').onclick = ()=>{ currentFilter='all'; setActiveTabs(); render(); };
    document.getElementById('tabPaused').onclick = ()=>{ currentFilter='paused'; setActiveTabs(); render(); };
    document.getElementById('tabLimited').onclick = ()=>{ currentFilter='limited'; setActiveTabs(); render(); };

    setActiveTabs();
    loadData().then(render);
  </script>
</body>
</html>